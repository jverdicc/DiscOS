// Copyright (c) 2026 Joseph Verdicchio and DiscOS  Contributors
// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";

package evidenceos.v1;

service EvidenceOS {
  rpc Health(HealthRequest) returns (HealthResponse);

  rpc CreateClaim(CreateClaimRequest) returns (CreateClaimResponse);
  rpc CommitArtifacts(CommitArtifactsRequest) returns (CommitArtifactsResponse);
  rpc FreezeGates(FreezeGatesRequest) returns (FreezeGatesResponse);
  rpc SealClaim(SealClaimRequest) returns (SealClaimResponse);
  rpc ExecuteClaim(ExecuteClaimRequest) returns (ExecuteClaimResponse);

  rpc FetchCapsule(FetchCapsuleRequest) returns (FetchCapsuleResponse);
  rpc GetSignedTreeHead(GetSignedTreeHeadRequest) returns (GetSignedTreeHeadResponse);
  rpc GetInclusionProof(GetInclusionProofRequest) returns (GetInclusionProofResponse);
  rpc GetConsistencyProof(GetConsistencyProofRequest) returns (GetConsistencyProofResponse);

  rpc RevokeClaim(RevokeClaimRequest) returns (RevokeClaimResponse);
  rpc WatchRevocations(WatchRevocationsRequest) returns (stream RevocationEvent);
}

message HealthRequest {}
message HealthResponse {
  string status = 1;
}

message ClaimMetadata {
  string lane = 1;
  uint32 alpha_micros = 2;
  string epoch_config_ref = 3;
  string output_schema_id = 4;
}

message TopicSignals {
  bytes semantic_hash = 1;
  bytes phys_hir_signature_hash = 2;
  bytes dependency_merkle_root = 3;
}

message CreateClaimRequest {
  string claim_id = 1;
  ClaimMetadata metadata = 2;
  TopicSignals signals = 3;
}

message CreateClaimResponse {
  string claim_id = 1;
  bytes topic_id = 2;
}

message ArtifactManifest {
  string name = 1;
  bytes canonical_bytes = 2;
  bytes digest = 3;
}

message CommitArtifactsRequest {
  string claim_id = 1;
  bytes wasm_module = 2;
  bytes wasm_hash = 3;
  repeated ArtifactManifest manifests = 4;
}

message CommitArtifactsResponse {
  bool accepted = 1;
}

message FreezeGatesRequest {
  string claim_id = 1;
}

message FreezeGatesResponse {
  bool frozen = 1;
}

message SealClaimRequest {
  string claim_id = 1;
}

message SealClaimResponse {
  bool sealed = 1;
}

message ExecuteClaimRequest {
  string claim_id = 1;
}

message ExecuteClaimResponse {
  bool executed = 1;
  string execution_id = 2;
}

message FetchCapsuleRequest {
  string claim_id = 1;
}

message MerkleInclusionProof {
  bytes leaf_hash = 1;
  uint64 leaf_index = 2;
  uint64 tree_size = 3;
  repeated bytes audit_path = 4;
}

message MerkleConsistencyProof {
  uint64 old_tree_size = 1;
  uint64 new_tree_size = 2;
  repeated bytes path = 3;
}

message FetchCapsuleResponse {
  string claim_id = 1;
  bytes capsule = 2;
  uint64 etl_index = 3;
  uint64 etl_tree_size = 4;
  bytes etl_root_hash = 5;
  bytes sth_signature = 6;
  MerkleInclusionProof inclusion = 7;
  MerkleConsistencyProof consistency = 8;
}

message SignedTreeHead {
  uint64 tree_size = 1;
  bytes root_hash = 2;
  bytes signature = 3;
}

message GetSignedTreeHeadRequest {}

message GetSignedTreeHeadResponse {
  SignedTreeHead sth = 1;
}

message GetInclusionProofRequest {
  bytes leaf_hash = 1;
  uint64 leaf_index = 2;
  uint64 tree_size = 3;
}

message GetInclusionProofResponse {
  MerkleInclusionProof proof = 1;
}

message GetConsistencyProofRequest {
  uint64 old_tree_size = 1;
  uint64 new_tree_size = 2;
}

message GetConsistencyProofResponse {
  MerkleConsistencyProof proof = 1;
}

message RevokeClaimRequest {
  string claim_id = 1;
  string reason_code = 2;
}

message RevokeClaimResponse {
  bool revoked = 1;
}

message WatchRevocationsRequest {}

message RevocationEvent {
  string claim_id = 1;
  string reason_code = 2;
  uint64 logical_epoch = 3;
}
